groups:
  - name: recruitment-platform
    rules:

    # API Health Alerts
    - alert: APIHighErrorRate
      expr: rate(http_requests_total{job="recruitment-api", status!~"2.."}[5m]) / rate(http_requests_total{job="recruitment-api"}[5m]) > 0.05
      for: 5m
      labels:
        severity: critical
        service: recruitment-api
      annotations:
        summary: "High error rate on recruitment API"
        description: "Error rate is {{ $value | printf \"%.2f\" }}% for the last 5 minutes"

    - alert: APIHighLatency
      expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="recruitment-api"}[5m])) > 2
      for: 5m
      labels:
        severity: warning
        service: recruitment-api
      annotations:
        summary: "High API latency"
        description: "95th percentile latency is {{ $value }}s for the last 5 minutes"

    - alert: APIDown
      expr: up{job="recruitment-api"} == 0
      for: 2m
      labels:
        severity: critical
        service: recruitment-api
      annotations:
        summary: "Recruitment API is down"
        description: "API has been down for more than 2 minutes"

    # Database Alerts
    - alert: DatabaseHighConnections
      expr: sql_connections > 80
      for: 5m
      labels:
        severity: warning
        service: database
      annotations:
        summary: "High database connections"
        description: "Database connections at {{ $value }}% capacity"

    - alert: DatabaseSlowQueries
      expr: increase(sql_slow_queries_total[5m]) > 10
      for: 2m
      labels:
        severity: warning
        service: database
      annotations:
        summary: "High number of slow queries"
        description: "{{ $value }} slow queries detected in the last 5 minutes"

    - alert: DatabaseDown
      expr: up{job="sql-server"} == 0
      for: 1m
      labels:
        severity: critical
        service: database
      annotations:
        summary: "Database is down"
        description: "Database has been unreachable for more than 1 minute"

    # Redis Alerts
    - alert: RedisHighMemoryUsage
      expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
      for: 5m
      labels:
        severity: warning
        service: redis
      annotations:
        summary: "High Redis memory usage"
        description: "Redis memory usage at {{ $value | printf \"%.2f\" }}%"

    - alert: RedisDown
      expr: up{job="redis"} == 0
      for: 1m
      labels:
        severity: critical
        service: redis
      annotations:
        summary: "Redis is down"
        description: "Redis has been unreachable for more than 1 minute"

    # AI Services Alerts
    - alert: AIServiceDown
      expr: up{job=~"ai-.*"} == 0
      for: 3m
      labels:
        severity: warning
        service: ai-services
      annotations:
        summary: "AI service is down"
        description: "AI service has been down for more than 3 minutes"

    - alert: AIServiceHighLatency
      expr: histogram_quantile(0.95, rate(ai_service_duration_seconds_bucket[5m])) > 10
      for: 5m
      labels:
        severity: warning
        service: ai-services
      annotations:
        summary: "High AI service latency"
        description: "95th percentile AI service latency is {{ $value }}s"

    # Business Metrics Alerts
    - alert: LowConversionRate
      expr: increase(conversions_total[1h]) / increase(applications_total[1h]) < 0.05
      for: 1h
      labels:
        severity: warning
        service: business-metrics
      annotations:
        summary: "Low conversion rate"
        description: "Conversion rate below 5% for the last hour"

    - alert: HighCommissionDisputes
      expr: increase(commission_disputes_total[1h]) > 5
      for: 1h
      labels:
        severity: warning
        service: business-metrics
      annotations:
        summary: "High number of commission disputes"
        description: "{{ $value }} commission disputes in the last hour"

    # Infrastructure Alerts
    - alert: PodCrashLooping
      expr: increase(kube_pod_container_status_restarts_total[10m]) > 5
      for: 5m
      labels:
        severity: critical
        service: kubernetes
      annotations:
        summary: "Pod crash looping"
        description: "Pod has restarted {{ $value }} times in the last 10 minutes"

    - alert: HighCPUUsage
      expr: (1 - avg(irate(node_cpu_seconds_total{mode="idle"}[5m]))) * 100 > 80
      for: 10m
      labels:
        severity: warning
        service: infrastructure
      annotations:
        summary: "High CPU usage"
        description: "CPU usage above 80% for more than 10 minutes"

    - alert: HighMemoryUsage
      expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
      for: 5m
      labels:
        severity: warning
        service: infrastructure
      annotations:
        summary: "High memory usage"
        description: "Memory usage above 85% for more than 5 minutes"

    - alert: DiskSpaceLow
      expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 < 10
      for: 5m
      labels:
        severity: critical
        service: infrastructure
      annotations:
        summary: "Low disk space"
        description: "Disk space below 10% on {{ $labels.mountpoint }}"

    # Security Alerts
    - alert: HighFailedLogins
      expr: increase(authentication_failures_total[5m]) > 10
      for: 2m
      labels:
        severity: warning
        service: security
      annotations:
        summary: "High number of failed login attempts"
        description: "{{ $value }} failed login attempts in the last 5 minutes"

    - alert: UnusualAPIAccess
      expr: increase(api_access_anomalies_total[1h]) > 0
      for: 1h
      labels:
        severity: warning
        service: security
      annotations:
        summary: "Unusual API access pattern detected"
        description: "Anomalous API access detected in the last hour"